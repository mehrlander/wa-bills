<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WA Bills Data Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab:hover {
            background: #f0f0ff;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter:hover {
            background: #e0e0e0;
        }

        .filter.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f8f8;
            font-weight: 600;
            color: #667eea;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f5f5ff;
        }

        .card {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .card-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #667eea;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
            margin-right: 5px;
        }

        .badge-budget {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-policy {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-mixed {
            background: #fff3e0;
            color: #f57c00;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .query-builder {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .query-result {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #999;
        }

        .btn-secondary:hover {
            background: #777;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .money {
            color: #2e7d32;
            font-weight: 500;
        }

        .section-title {
            font-size: 1.5em;
            margin: 30px 0 15px 0;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WA Bills Data Explorer</h1>
            <div class="subtitle">Interactive analysis of Washington State legislation</div>
        </header>

        <div id="stats" class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-bills">-</div>
                <div class="stat-label">Total Bills</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-agencies">-</div>
                <div class="stat-label">Agencies</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-appropriations">-</div>
                <div class="stat-label">Appropriations</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-amount">-</div>
                <div class="stat-label">Total Amount</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('bills')">Bills</div>
            <div class="tab" onclick="switchTab('agencies')">Agencies</div>
            <div class="tab" onclick="switchTab('appropriations')">Appropriations</div>
            <div class="tab" onclick="switchTab('accounts')">Accounts</div>
            <div class="tab" onclick="switchTab('query')">Query Builder</div>
            <div class="tab" onclick="switchTab('charts')">Charts</div>
        </div>

        <div id="bills-tab" class="tab-content active">
            <h2 class="section-title">Bills Overview</h2>
            <div class="filters" id="bill-filters">
                <div class="filter active" data-filter="all">All Bills</div>
                <div class="filter" data-filter="budget">Budget</div>
                <div class="filter" data-filter="policy">Policy</div>
                <div class="filter" data-filter="mixed">Mixed</div>
            </div>
            <input type="text" class="search-box" id="bill-search" placeholder="Search bills by number, title, or sponsor...">
            <div id="bills-list"></div>
        </div>

        <div id="agencies-tab" class="tab-content">
            <h2 class="section-title">Agencies</h2>
            <input type="text" class="search-box" id="agency-search" placeholder="Search agencies...">
            <div id="agencies-list"></div>
        </div>

        <div id="appropriations-tab" class="tab-content">
            <h2 class="section-title">Appropriations</h2>
            <input type="text" class="search-box" id="approp-search" placeholder="Search appropriations...">
            <div>
                <label>Sort by: </label>
                <select id="approp-sort" onchange="renderAppropriations()">
                    <option value="amount-desc">Amount (High to Low)</option>
                    <option value="amount-asc">Amount (Low to High)</option>
                    <option value="bill">Bill Number</option>
                    <option value="account">Account Name</option>
                </select>
            </div>
            <div id="appropriations-list"></div>
        </div>

        <div id="accounts-tab" class="tab-content">
            <h2 class="section-title">Accounts Summary</h2>
            <div id="accounts-list"></div>
        </div>

        <div id="query-tab" class="tab-content">
            <h2 class="section-title">Query Builder</h2>
            <div class="query-builder">
                <p><strong>Use lodash to query the data:</strong></p>
                <p>Available objects: <code>billsData</code>, <code>billsIndex</code></p>
                <p>Example queries:</p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li><code>_.filter(billsIndex, {type: 'budget'})</code></li>
                    <li><code>_.sumBy(billsData.appropriations, 'numericAmount')</code></li>
                    <li><code>_.take(_.sortBy(billsData.agencies, a => -a.billsAppearingIn.length), 10)</code></li>
                </ul>
                <textarea id="query-input" style="width: 100%; height: 100px; padding: 10px; font-family: 'Courier New', monospace; border: 2px solid #ddd; border-radius: 6px;" placeholder="Enter lodash query...">_.filter(billsIndex, {type: 'budget'})</textarea>
                <br><br>
                <button class="btn" onclick="executeQuery()">Execute Query</button>
                <button class="btn btn-secondary" onclick="clearQuery()">Clear</button>
            </div>
            <div id="query-output"></div>
        </div>

        <div id="charts-tab" class="tab-content">
            <h2 class="section-title">Data Visualizations</h2>

            <h3 style="margin-top: 30px;">Bills by Type</h3>
            <div class="chart-container">
                <canvas id="billTypeChart"></canvas>
            </div>

            <h3 style="margin-top: 30px;">Top 10 Agencies by Bill Appearances</h3>
            <div class="chart-container">
                <canvas id="agencyChart"></canvas>
            </div>

            <h3 style="margin-top: 30px;">Top 10 Accounts by Total Appropriations</h3>
            <div class="chart-container">
                <canvas id="accountChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let billsData = null;
        let billsIndex = null;
        let currentBillFilter = 'all';

        // Load data
        async function loadData() {
            try {
                const [dataResponse, indexResponse] = await Promise.all([
                    fetch('bills-data.json'),
                    fetch('bills-index.json')
                ]);

                billsData = await dataResponse.json();
                billsIndex = await indexResponse.json();

                initializeDashboard();
            } catch (error) {
                document.getElementById('bills-list').innerHTML = `
                    <div class="error">
                        Error loading data: ${error.message}<br>
                        Make sure bills-data.json and bills-index.json are in the same directory.
                    </div>
                `;
            }
        }

        function initializeDashboard() {
            // Update stats
            document.getElementById('total-bills').textContent = billsData.metadata.totalBills;
            document.getElementById('total-agencies').textContent = billsData.metadata.totalAgencies;
            document.getElementById('total-appropriations').textContent = billsData.metadata.totalAppropriations.toLocaleString();

            const totalAmount = _.sumBy(billsData.appropriations, 'numericAmount');
            document.getElementById('total-amount').textContent = '$' + (totalAmount / 1e9).toFixed(1) + 'B';

            // Render initial views
            renderBills();
            renderAgencies();
            renderAppropriations();
            renderAccounts();
            renderCharts();

            // Setup search handlers
            document.getElementById('bill-search').addEventListener('input', renderBills);
            document.getElementById('agency-search').addEventListener('input', renderAgencies);
            document.getElementById('approp-search').addEventListener('input', renderAppropriations);

            // Setup filter handlers
            document.querySelectorAll('#bill-filters .filter').forEach(filter => {
                filter.addEventListener('click', (e) => {
                    document.querySelectorAll('#bill-filters .filter').forEach(f => f.classList.remove('active'));
                    e.target.classList.add('active');
                    currentBillFilter = e.target.dataset.filter;
                    renderBills();
                });
            });
        }

        function renderBills() {
            const searchTerm = document.getElementById('bill-search').value.toLowerCase();
            let filtered = billsIndex;

            if (currentBillFilter !== 'all') {
                filtered = _.filter(filtered, {type: currentBillFilter});
            }

            if (searchTerm) {
                filtered = _.filter(filtered, bill =>
                    (bill.billNumber?.toLowerCase().includes(searchTerm)) ||
                    (bill.title?.toLowerCase().includes(searchTerm)) ||
                    (bill.sponsors?.toLowerCase().includes(searchTerm))
                );
            }

            const html = filtered.map(bill => `
                <div class="card">
                    <div class="card-title">
                        ${bill.billNumber || 'Unknown'}
                        <span class="badge badge-${bill.type}">${bill.type}</span>
                        ${bill.hasVeto ? '<span class="badge" style="background: #ffcdd2; color: #c62828;">Vetoed</span>' : ''}
                    </div>
                    <div><strong>Title:</strong> ${bill.title || 'N/A'}</div>
                    ${bill.briefDescription ? `<div><strong>Description:</strong> ${bill.briefDescription}</div>` : ''}
                    ${bill.sponsors ? `<div><strong>Sponsors:</strong> ${bill.sponsors}</div>` : ''}
                    ${bill.session ? `<div><strong>Session:</strong> ${bill.session}</div>` : ''}
                    <div style="margin-top: 10px;">
                        <strong>Stats:</strong>
                        ${bill.stats.appropriationCount ? bill.stats.appropriationCount + ' appropriations' : ''}
                        ${bill.stats.agencyCount ? ', ' + bill.stats.agencyCount + ' agencies' : ''}
                        ${bill.stats.sectionCount ? ', ' + bill.stats.sectionCount + ' sections' : ''}
                    </div>
                </div>
            `).join('');

            document.getElementById('bills-list').innerHTML = html || '<p>No bills found.</p>';
        }

        function renderAgencies() {
            const searchTerm = document.getElementById('agency-search').value.toLowerCase();
            let agencies = billsData.agencies;

            if (searchTerm) {
                agencies = _.filter(agencies, a => a.name.toLowerCase().includes(searchTerm));
            }

            agencies = _.sortBy(agencies, a => -a.billsAppearingIn.length);

            const html = agencies.map(agency => `
                <div class="card">
                    <div class="card-title">${agency.name}</div>
                    <div><strong>Appears in ${agency.billsAppearingIn.length} bill(s):</strong> ${agency.billsAppearingIn.join(', ')}</div>
                </div>
            `).join('');

            document.getElementById('agencies-list').innerHTML = html || '<p>No agencies found.</p>';
        }

        function renderAppropriations() {
            const searchTerm = document.getElementById('approp-search').value.toLowerCase();
            const sortBy = document.getElementById('approp-sort').value;

            let appropriations = billsData.appropriations;

            if (searchTerm) {
                appropriations = _.filter(appropriations, a =>
                    a.account.toLowerCase().includes(searchTerm) ||
                    a.billNumber.toLowerCase().includes(searchTerm)
                );
            }

            // Sort
            switch (sortBy) {
                case 'amount-desc':
                    appropriations = _.sortBy(appropriations, a => -a.numericAmount);
                    break;
                case 'amount-asc':
                    appropriations = _.sortBy(appropriations, 'numericAmount');
                    break;
                case 'bill':
                    appropriations = _.sortBy(appropriations, 'billNumber');
                    break;
                case 'account':
                    appropriations = _.sortBy(appropriations, 'account');
                    break;
            }

            // Limit to first 100 for performance
            const display = _.take(appropriations, 100);

            const html = `
                <p>Showing ${display.length} of ${appropriations.length} appropriations</p>
                <table>
                    <thead>
                        <tr>
                            <th>Bill</th>
                            <th>Account</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${display.map(a => `
                            <tr>
                                <td>${a.billNumber}</td>
                                <td>${a.account}</td>
                                <td class="money">$${a.numericAmount.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('appropriations-list').innerHTML = html;
        }

        function renderAccounts() {
            const accounts = _.sortBy(billsData.accounts, a => -a.totalAmount);
            const top20 = _.take(accounts, 20);

            const html = `
                <p>Showing top 20 of ${accounts.length} accounts</p>
                <table>
                    <thead>
                        <tr>
                            <th>Account</th>
                            <th>Total Amount</th>
                            <th>Occurrences</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${top20.map(a => `
                            <tr>
                                <td>${a.account}</td>
                                <td class="money">$${a.totalAmount.toLocaleString()}</td>
                                <td>${a.occurrences}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('accounts-list').innerHTML = html;
        }

        function renderCharts() {
            // Bill type chart
            const typeData = {
                labels: ['Budget', 'Policy', 'Mixed'],
                datasets: [{
                    data: [
                        billsData.metadata.budgetBills,
                        billsData.metadata.policyBills,
                        billsData.metadata.mixedBills
                    ],
                    backgroundColor: ['#667eea', '#764ba2', '#f093fb']
                }]
            };

            new Chart(document.getElementById('billTypeChart'), {
                type: 'doughnut',
                data: typeData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Agency chart
            const topAgencies = _.take(_.sortBy(billsData.agencies, a => -a.billsAppearingIn.length), 10);
            const agencyData = {
                labels: topAgencies.map(a => a.name.length > 40 ? a.name.substring(0, 40) + '...' : a.name),
                datasets: [{
                    label: 'Number of Bills',
                    data: topAgencies.map(a => a.billsAppearingIn.length),
                    backgroundColor: '#667eea'
                }]
            };

            new Chart(document.getElementById('agencyChart'), {
                type: 'bar',
                data: agencyData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Account chart
            const topAccounts = _.take(_.sortBy(billsData.accounts, a => -a.totalAmount), 10);
            const accountData = {
                labels: topAccounts.map(a => a.account.length > 40 ? a.account.substring(0, 40) + '...' : a.account),
                datasets: [{
                    label: 'Total Amount ($)',
                    data: topAccounts.map(a => a.totalAmount),
                    backgroundColor: '#764ba2'
                }]
            };

            new Chart(document.getElementById('accountChart'), {
                type: 'bar',
                data: accountData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1e9).toFixed(1) + 'B';
                                }
                            }
                        }
                    }
                }
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function executeQuery() {
            const query = document.getElementById('query-input').value;
            const output = document.getElementById('query-output');

            try {
                const result = eval(query);
                output.innerHTML = `
                    <div class="section-title">Query Result</div>
                    <div class="query-result">
                        ${JSON.stringify(result, null, 2)}
                    </div>
                `;
            } catch (error) {
                output.innerHTML = `
                    <div class="error">
                        Error executing query: ${error.message}
                    </div>
                `;
            }
        }

        function clearQuery() {
            document.getElementById('query-input').value = '';
            document.getElementById('query-output').innerHTML = '';
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
