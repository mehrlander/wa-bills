<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Washington State Agency Network Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
        }

        #header {
            background: #1e293b;
            border-bottom: 2px solid #334155;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        #controls {
            background: #1e293b;
            padding: 1rem 1.5rem;
            display: flex;
            gap: 2rem;
            align-items: center;
            border-bottom: 1px solid #334155;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .control-group label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input[type="range"] {
            width: 200px;
        }

        select, input[type="text"] {
            background: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        input[type="text"] {
            width: 300px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        #stats {
            background: #1e293b;
            padding: 1rem 1.5rem;
            display: flex;
            gap: 3rem;
            border-bottom: 1px solid #334155;
        }

        .stat {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6;
        }

        #viz-container {
            position: relative;
            height: calc(100vh - 220px);
        }

        #tooltip {
            position: absolute;
            background: rgba(30, 41, 59, 0.98);
            border: 1px solid #475569;
            border-radius: 0.5rem;
            padding: 1rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #475569;
            padding-bottom: 0.5rem;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            font-size: 0.875rem;
        }

        .tooltip-label {
            color: #94a3b8;
        }

        .tooltip-value {
            color: #e2e8f0;
            font-weight: 500;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #475569;
            border-radius: 0.5rem;
            padding: 1rem;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .legend-title {
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #f1f5f9;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }

        .legend-line {
            width: 30px;
            height: 2px;
        }

        .legend-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .node {
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .node:hover {
            opacity: 0.8;
        }

        .link {
            stroke-opacity: 0.6;
            transition: stroke-opacity 0.3s;
        }

        .link:hover {
            stroke-opacity: 1;
        }

        text {
            font-size: 11px;
            pointer-events: none;
            fill: #cbd5e1;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .highlighted {
            opacity: 1 !important;
        }

        .dimmed {
            opacity: 0.2 !important;
        }

        .value-display {
            font-size: 0.875rem;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Washington State Agency Network Visualization</h1>
        <div class="subtitle">Interactive network diagram showing agencies, programs, and relationships across legislative bills</div>
    </div>

    <div id="controls">
        <div class="control-group">
            <label>Search Agency</label>
            <input type="text" id="search" placeholder="Type to search agencies...">
        </div>

        <div class="control-group">
            <label>Filter by Relationship</label>
            <select id="relationship-filter">
                <option value="all">All Relationships</option>
                <option value="collaboration">Collaboration</option>
                <option value="transfer">Transfer</option>
                <option value="oversees">Oversight</option>
            </select>
        </div>

        <div class="control-group">
            <label>Minimum Mentions: <span class="value-display" id="min-mentions-value">10</span></label>
            <input type="range" id="min-mentions" min="1" max="100" value="10">
        </div>

        <div class="control-group">
            <label>Node Size: <span class="value-display" id="node-size-value">Medium</span></label>
            <input type="range" id="node-size" min="0.5" max="2" step="0.1" value="1">
        </div>
    </div>

    <div id="stats">
        <div class="stat">
            <div class="stat-label">Total Agencies</div>
            <div class="stat-value" id="total-agencies">0</div>
        </div>
        <div class="stat">
            <div class="stat-label">Visible Agencies</div>
            <div class="stat-value" id="visible-agencies">0</div>
        </div>
        <div class="stat">
            <div class="stat-label">Relationships</div>
            <div class="stat-value" id="total-relationships">0</div>
        </div>
        <div class="stat">
            <div class="stat-label">Visible Relationships</div>
            <div class="stat-value" id="visible-relationships">0</div>
        </div>
    </div>

    <div id="viz-container">
        <svg id="network"></svg>
        <div id="tooltip">
            <div class="tooltip-title"></div>
            <div class="tooltip-content"></div>
        </div>

        <div class="legend">
            <div class="legend-title">Relationship Types</div>
            <div class="legend-item">
                <div class="legend-line" style="background: #3b82f6;"></div>
                <span>Collaboration</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #f59e0b;"></div>
                <span>Transfer</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #10b981;"></div>
                <span>Oversight</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #6366f1;"></div>
                <span>Other</span>
            </div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #475569;">
                <div class="legend-title">Node Size</div>
                <div style="color: #94a3b8; font-size: 0.75rem; margin-top: 0.5rem;">
                    Based on number of mentions
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load data and initialize visualization
        Promise.all([
            d3.json('agency-network.json'),
            d3.json('agency-index.json')
        ]).then(([networkData, indexData]) => {
            // Enrich nodes with index data
            networkData.nodes.forEach(node => {
                const details = indexData[node.id];
                if (details) {
                    node.programs = details.total_programs || 0;
                    node.bills = details.bills || [];
                    node.actions = details.action_types || {};
                }
            });

            const viz = new AgencyNetworkVisualization(networkData, indexData);
            viz.init();
        }).catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('viz-container').innerHTML =
                '<div style="padding: 2rem; text-align: center; color: #ef4444;">Error loading data. Please ensure agency-network.json and agency-index.json are in the same directory.</div>';
        });

        class AgencyNetworkVisualization {
            constructor(networkData, indexData) {
                this.allNodes = networkData.nodes;
                this.allEdges = networkData.edges;
                this.indexData = indexData;

                this.filteredNodes = [...this.allNodes];
                this.filteredEdges = [...this.allEdges];

                this.width = window.innerWidth;
                this.height = window.innerHeight - 220;

                this.svg = d3.select('#network')
                    .attr('width', this.width)
                    .attr('height', this.height);

                this.container = this.svg.append('g');

                // Color scale for relationship types
                this.colorScale = {
                    'collaboration': '#3b82f6',
                    'transfer': '#f59e0b',
                    'transfer_from': '#f59e0b',
                    'oversees': '#10b981',
                    'overseen_by': '#10b981',
                    'default': '#6366f1'
                };

                this.nodeSizeScale = 1;
            }

            init() {
                // Setup zoom
                const zoom = d3.zoom()
                    .scaleExtent([0.1, 4])
                    .on('zoom', (event) => {
                        this.container.attr('transform', event.transform);
                    });

                this.svg.call(zoom);

                // Initial render
                this.updateStats();
                this.render();

                // Setup controls
                this.setupControls();

                // Handle window resize
                window.addEventListener('resize', () => {
                    this.width = window.innerWidth;
                    this.height = window.innerHeight - 220;
                    this.svg.attr('width', this.width).attr('height', this.height);
                    if (this.simulation) {
                        this.simulation.force('center', d3.forceCenter(this.width / 2, this.height / 2));
                        this.simulation.alpha(0.3).restart();
                    }
                });
            }

            setupControls() {
                // Search
                d3.select('#search').on('input', (event) => {
                    const query = event.target.value.toLowerCase();
                    this.filterBySearch(query);
                });

                // Relationship filter
                d3.select('#relationship-filter').on('change', (event) => {
                    this.filterByRelationship(event.target.value);
                });

                // Minimum mentions slider
                d3.select('#min-mentions').on('input', (event) => {
                    const value = +event.target.value;
                    d3.select('#min-mentions-value').text(value);
                    this.filterByMentions(value);
                });

                // Node size slider
                d3.select('#node-size').on('input', (event) => {
                    const value = +event.target.value;
                    this.nodeSizeScale = value;
                    const label = value < 0.8 ? 'Small' : value > 1.2 ? 'Large' : 'Medium';
                    d3.select('#node-size-value').text(label);
                    this.updateNodeSizes();
                });
            }

            filterBySearch(query) {
                if (!query) {
                    this.filteredNodes = [...this.allNodes];
                } else {
                    this.filteredNodes = this.allNodes.filter(node =>
                        node.id.toLowerCase().includes(query)
                    );
                }
                this.updateFilteredEdges();
                this.updateStats();
                this.render();
            }

            filterByRelationship(relType) {
                if (relType === 'all') {
                    this.filteredEdges = this.allEdges.filter(edge => {
                        const sourceExists = this.filteredNodes.some(n => n.id === edge.source.id || n.id === edge.source);
                        const targetExists = this.filteredNodes.some(n => n.id === edge.target.id || n.id === edge.target);
                        return sourceExists && targetExists;
                    });
                } else {
                    this.filteredEdges = this.allEdges.filter(edge => {
                        const matchesType = edge.type === relType;
                        const sourceExists = this.filteredNodes.some(n => n.id === edge.source.id || n.id === edge.source);
                        const targetExists = this.filteredNodes.some(n => n.id === edge.target.id || n.id === edge.target);
                        return matchesType && sourceExists && targetExists;
                    });
                }
                this.updateStats();
                this.render();
            }

            filterByMentions(minMentions) {
                this.filteredNodes = this.allNodes.filter(node => node.mentions >= minMentions);
                this.updateFilteredEdges();
                this.updateStats();
                this.render();
            }

            updateFilteredEdges() {
                const nodeIds = new Set(this.filteredNodes.map(n => n.id));
                this.filteredEdges = this.allEdges.filter(edge => {
                    const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                    const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                    return nodeIds.has(sourceId) && nodeIds.has(targetId);
                });
            }

            updateStats() {
                d3.select('#total-agencies').text(this.allNodes.length.toLocaleString());
                d3.select('#visible-agencies').text(this.filteredNodes.length.toLocaleString());
                d3.select('#total-relationships').text(this.allEdges.length.toLocaleString());
                d3.select('#visible-relationships').text(this.filteredEdges.length.toLocaleString());
            }

            updateNodeSizes() {
                if (this.nodeElements) {
                    this.nodeElements.attr('r', d => this.getNodeRadius(d));
                }
            }

            getNodeRadius(d) {
                const baseRadius = Math.sqrt(d.mentions) * 0.8 + 3;
                return baseRadius * this.nodeSizeScale;
            }

            getEdgeColor(type) {
                return this.colorScale[type] || this.colorScale.default;
            }

            render() {
                // Clear existing
                this.container.selectAll('*').remove();

                // Create simulation
                this.simulation = d3.forceSimulation(this.filteredNodes)
                    .force('link', d3.forceLink(this.filteredEdges)
                        .id(d => d.id)
                        .distance(100))
                    .force('charge', d3.forceManyBody().strength(-300))
                    .force('center', d3.forceCenter(this.width / 2, this.height / 2))
                    .force('collision', d3.forceCollide().radius(d => this.getNodeRadius(d) + 5));

                // Create links
                this.linkElements = this.container.append('g')
                    .selectAll('line')
                    .data(this.filteredEdges)
                    .enter()
                    .append('line')
                    .attr('class', 'link')
                    .attr('stroke', d => this.getEdgeColor(d.type))
                    .attr('stroke-width', 1.5);

                // Create nodes
                this.nodeElements = this.container.append('g')
                    .selectAll('circle')
                    .data(this.filteredNodes)
                    .enter()
                    .append('circle')
                    .attr('class', 'node')
                    .attr('r', d => this.getNodeRadius(d))
                    .attr('fill', d => {
                        const hue = (d.mentions * 137.5) % 360;
                        return `hsl(${hue}, 70%, 60%)`;
                    })
                    .attr('stroke', '#1e293b')
                    .attr('stroke-width', 2)
                    .call(this.drag(this.simulation))
                    .on('mouseover', (event, d) => this.showTooltip(event, d))
                    .on('mouseout', () => this.hideTooltip())
                    .on('click', (event, d) => this.highlightNode(d));

                // Create labels for top agencies
                const topAgencies = [...this.filteredNodes]
                    .sort((a, b) => b.mentions - a.mentions)
                    .slice(0, 20);

                this.labelElements = this.container.append('g')
                    .selectAll('text')
                    .data(topAgencies)
                    .enter()
                    .append('text')
                    .text(d => {
                        const name = d.id;
                        return name.length > 30 ? name.substring(0, 30) + '...' : name;
                    })
                    .attr('font-size', 11)
                    .attr('dx', d => this.getNodeRadius(d) + 5)
                    .attr('dy', 4);

                // Update positions on tick
                this.simulation.on('tick', () => {
                    this.linkElements
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);

                    this.nodeElements
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);

                    if (this.labelElements) {
                        this.labelElements
                            .attr('x', d => d.x)
                            .attr('y', d => d.y);
                    }
                });
            }

            drag(simulation) {
                function dragstarted(event) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                }

                function dragged(event) {
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                }

                function dragended(event) {
                    if (!event.active) simulation.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                }

                return d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended);
            }

            showTooltip(event, d) {
                const tooltip = d3.select('#tooltip');
                const details = this.indexData[d.id] || {};

                let content = `
                    <div class="tooltip-row">
                        <span class="tooltip-label">Mentions:</span>
                        <span class="tooltip-value">${d.mentions.toLocaleString()}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Bills:</span>
                        <span class="tooltip-value">${d.bills.length}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Programs:</span>
                        <span class="tooltip-value">${d.programs}</span>
                    </div>
                `;

                if (details.total_appropriations > 0) {
                    content += `
                        <div class="tooltip-row">
                            <span class="tooltip-label">Funding:</span>
                            <span class="tooltip-value">$${details.total_appropriations.toLocaleString()}</span>
                        </div>
                    `;
                }

                tooltip.select('.tooltip-title').text(d.id);
                tooltip.select('.tooltip-content').html(content);
                tooltip.classed('visible', true)
                    .style('left', (event.pageX + 15) + 'px')
                    .style('top', (event.pageY + 15) + 'px');
            }

            hideTooltip() {
                d3.select('#tooltip').classed('visible', false);
            }

            highlightNode(node) {
                const connectedNodeIds = new Set([node.id]);

                this.filteredEdges.forEach(edge => {
                    const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                    const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;

                    if (sourceId === node.id) connectedNodeIds.add(targetId);
                    if (targetId === node.id) connectedNodeIds.add(sourceId);
                });

                this.nodeElements.classed('dimmed', d => !connectedNodeIds.has(d.id));
                this.nodeElements.classed('highlighted', d => d.id === node.id);

                this.linkElements.classed('dimmed', d => {
                    const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                    const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                    return sourceId !== node.id && targetId !== node.id;
                });

                // Double click to reset
                setTimeout(() => {
                    this.nodeElements.on('dblclick', () => {
                        this.nodeElements.classed('dimmed', false).classed('highlighted', false);
                        this.linkElements.classed('dimmed', false);
                    });
                }, 100);
            }
        }
    </script>
</body>
</html>
